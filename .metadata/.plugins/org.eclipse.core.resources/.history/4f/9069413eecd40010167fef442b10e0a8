package com.railway.dao;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import com.railway.model.Train;
import com.railway.util.DBConnection; 

public class TrainDAO {
	public List<Train> getAllTrains() {
        List<Train> trains = new ArrayList<>();
        Connection conn = null;
        Statement stmt = null;
        ResultSet rs = null;
        try {
            conn = DBConnection.getConnection();
            stmt = conn.createStatement();
            String sql = "SELECT * FROM trains ORDER BY train_id";
            rs = stmt.executeQuery(sql);
            
            while (rs.next()) {
                Train train = extractTrainFromResultSet(rs);
                trains.add(train);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rs != null) rs.close();
                if (stmt != null) stmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return trains;
    }
	
	public List<Train> searchTrains(String source, String destination) {
	    List<Train> trains = new ArrayList<>();
	    Connection conn = null;
	    PreparedStatement pstmt = null;
	    ResultSet rs = null;
	    try {
	        conn = DBConnection.getConnection();
	        
	        // ðŸ§  FIXED LOGIC: Look inside station_distances for matches
	        String sql = "SELECT t.* FROM trains t " +
	                     "WHERE t.train_id IN (" +
	                     "    SELECT s1.train_id FROM station_distances s1 " +
	                     "    JOIN station_distances s2 ON s1.train_id = s2.train_id " +
	                     "    WHERE LOWER(s1.station_name) LIKE LOWER(?) " +  // Check Source
	                     "    AND LOWER(s2.station_name) LIKE LOWER(?) " +    // Check Destination
	                     "    AND s1.km_from_source < s2.km_from_source" +    // Ensure Direction is correct
	                     ") AND t.available_seats > 0";

	        pstmt = conn.prepareStatement(sql);
	        pstmt.setString(1, "%" + source + "%");
	        pstmt.setString(2, "%" + destination + "%");
	        
	        rs = pstmt.executeQuery();
	        while (rs.next()) {
	            Train train = extractTrainFromResultSet(rs);
	            
	            // Calculate Distance dynamically for this specific route
	            int dist = getRouteDistance(conn, train.getTrainId(), source, destination);
	            train.setJourneyDistance(dist);
	            
	            trains.add(train);
	        }
	    } catch (SQLException e) {
	        e.printStackTrace();
	    } finally {
	        // Ensure you have a method to close resources here
	        try { if(rs!=null)rs.close(); if(pstmt!=null)pstmt.close(); if(conn!=null)conn.close(); } catch(Exception e){}
	    }
	    return trains;
	}
	
	public Train getTrainById(int trainId) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = DBConnection.getConnection();
            String sql = "SELECT * FROM trains WHERE train_id = ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, trainId);
            
            rs = pstmt.executeQuery();
            if (rs.next()) {
                return extractTrainFromResultSet(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rs != null) rs.close();
                if (pstmt != null) pstmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return null;
    }
	
	public boolean updateAvailableSeats(int trainId, int seatsToBook) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        try {
            conn = DBConnection.getConnection();
            String sql = "UPDATE trains SET available_seats = available_seats - ? " +
                        "WHERE train_id = ? AND available_seats >= ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, seatsToBook);
            pstmt.setInt(2, trainId);
            pstmt.setInt(3, seatsToBook);
            
            int result = pstmt.executeUpdate();
            return result > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        } finally {
            try {
                if (pstmt != null) pstmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
	
	private Train extractTrainFromResultSet(ResultSet rs) throws SQLException {
        Train train = new Train();
        train.setTrainId(rs.getInt("train_id"));
        train.setTrainName(rs.getString("train_name"));
        train.setTrainNumber(rs.getString("train_number"));
        train.setSourceStation(rs.getString("source_station"));
        train.setDestinationStation(rs.getString("destination_station"));
        train.setDepartureTime(rs.getString("departure_time"));
        train.setArrivalTime(rs.getString("arrival_time"));
        train.setTotalSeats(rs.getInt("total_seats"));
        train.setAvailableSeats(rs.getInt("available_seats"));
        train.setFare(rs.getDouble("fare"));
        return train;
    }
	
	private int getRouteDistance(Connection conn, int trainId, String src, String dest) {
	    int km1 = 0, km2 = 0;
	    try {
	        PreparedStatement ps = conn.prepareStatement("SELECT km_from_source FROM station_distances WHERE train_id=? AND LOWER(station_name) LIKE LOWER(?)");
	        
	        // Get Source KM
	        ps.setInt(1, trainId); ps.setString(2, src);
	        ResultSet rs1 = ps.executeQuery();
	        if(rs1.next()) km1 = rs1.getInt(1);

	        // Get Dest KM
	        ps.setInt(1, trainId); ps.setString(2, dest);
	        ResultSet rs2 = ps.executeQuery();
	        if(rs2.next()) km2 = rs2.getInt(1);

	        // If either station is missing in the distance table, return 0 (or fallback logic)
	        if(km1 == 0 && km2 == 0) return 0;
	        
	        return Math.abs(km2 - km1); // Absolute difference (e.g. |200 - 500| = 300km)
	    } catch(Exception e) { return 0; }
	}
	
}
