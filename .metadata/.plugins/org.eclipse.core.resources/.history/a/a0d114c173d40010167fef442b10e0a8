package com.railway.dao;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import com.railway.model.Reservation;
import com.railway.util.DBConnection;
import java.util.Date;

public class ReservationDAO {
    
    // 1. Book a Ticket
    public boolean bookTicket(Reservation reservation) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        try {
            conn = DBConnection.getConnection();
            String sql = "INSERT INTO reservations (reservation_id, user_id, train_id, " +
                         "passenger_name, age, gender, journey_date, seats_booked, total_fare, booking_status) " +
                         "VALUES (reservation_seq.NEXTVAL, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, reservation.getUserId());
            pstmt.setInt(2, reservation.getTrainId());
            pstmt.setString(3, reservation.getPassengerName());
            pstmt.setInt(4, reservation.getAge());
            pstmt.setString(5, reservation.getGender());
            pstmt.setDate(6, new java.sql.Date(reservation.getJourneyDate().getTime()));
            pstmt.setInt(7, reservation.getSeatsBooked());
            pstmt.setDouble(8, reservation.getTotalFare());
            pstmt.setString(9, reservation.getBookingStatus());
            
            int result = pstmt.executeUpdate();
            return result > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        } finally {
            try {
                if (pstmt != null) pstmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
    
    // 2. Get User History (Used in my-bookings.jsp)
    public List<Reservation> getUserReservations(int userId) {
        List<Reservation> reservations = new ArrayList<>();
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = DBConnection.getConnection();
            // JOIN query to get Train Names along with Booking Info
            String sql = "SELECT r.*, t.train_name, t.train_number, t.source_station, " +
                         "t.destination_station FROM reservations r " +
                         "JOIN trains t ON r.train_id = t.train_id " +
                         "WHERE r.user_id = ? ORDER BY r.booking_date DESC";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, userId);
            
            rs = pstmt.executeQuery();
            while (rs.next()) {
                Reservation res = new Reservation();
                res.setReservationId(rs.getInt("reservation_id"));
                res.setUserId(rs.getInt("user_id"));
                res.setTrainId(rs.getInt("train_id"));
                res.setPassengerName(rs.getString("passenger_name"));
                res.setAge(rs.getInt("age"));
                res.setGender(rs.getString("gender"));
                res.setJourneyDate(rs.getDate("journey_date"));
                res.setSeatsBooked(rs.getInt("seats_booked"));
                res.setTotalFare(rs.getDouble("total_fare"));
                res.setBookingStatus(rs.getString("booking_status"));
                res.setBookingDate(rs.getDate("booking_date"));
                
                // Set extra train details for display
                res.setTrainName(rs.getString("train_name"));
                res.setTrainNumber(rs.getString("train_number"));
                res.setSourceStation(rs.getString("source_station"));
                res.setDestinationStation(rs.getString("destination_station"));
                
                reservations.add(res);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rs != null) rs.close();
                if (pstmt != null) pstmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return reservations;
    }
    
    // 3. Cancel Ticket (Optional Feature)
    public boolean cancelReservation(int reservationId, int trainId, int seats) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        try {
            conn = DBConnection.getConnection();
            conn.setAutoCommit(false); // Start Transaction
            
            // Step A: Mark as Cancelled
            String sql1 = "UPDATE reservations SET booking_status = 'CANCELLED' WHERE reservation_id = ?";
            pstmt = conn.prepareStatement(sql1);
            pstmt.setInt(1, reservationId);
            pstmt.executeUpdate();
            pstmt.close();
            
            // Step B: Return seats to the Train
            String sql2 = "UPDATE trains SET available_seats = available_seats + ? WHERE train_id = ?";
            pstmt = conn.prepareStatement(sql2);
            pstmt.setInt(1, seats);
            pstmt.setInt(2, trainId);
            pstmt.executeUpdate();
            
            conn.commit(); // Commit Transaction
            return true;
        } catch (SQLException e) {
            try {
                if (conn != null) conn.rollback(); // Undo if error
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
            e.printStackTrace();
            return false;
        } finally {
            try {
                if (pstmt != null) pstmt.close();
                if (conn != null) {
                    conn.setAutoCommit(true);
                    conn.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}